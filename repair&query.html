<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1,user-scalable=no">
	<title>报修</title>
	<link rel="stylesheet" type="text/css" href="./css/reset.css">
	<link rel="stylesheet" type="text/css" href="./css/repair&query.css">
	<script type="text/javascript">
	!function(a,b){function c(){var b=f.getBoundingClientRect().width;b/i>540&&(b=540*i);var c=b/10;f.style.fontSize=c+"px",k.rem=a.rem=c}var d,e=a.document,f=e.documentElement,g=e.querySelector('meta[name="viewport"]'),h=e.querySelector('meta[name="flexible"]'),i=0,j=0,k=b.flexible||(b.flexible={});if(g){console.warn("将根据已有的meta标签来设置缩放比例");var l=g.getAttribute("content").match(/initial\-scale=([\d\.]+)/);l&&(j=parseFloat(l[1]),i=parseInt(1/j))}else if(h){var m=h.getAttribute("content");if(m){var n=m.match(/initial\-dpr=([\d\.]+)/),o=m.match(/maximum\-dpr=([\d\.]+)/);n&&(i=parseFloat(n[1]),j=parseFloat((1/i).toFixed(2))),o&&(i=parseFloat(o[1]),j=parseFloat((1/i).toFixed(2)))}}if(!i&&!j){var p=(a.navigator.appVersion.match(/android/gi),a.navigator.appVersion.match(/iphone/gi)),q=a.devicePixelRatio;i=p?q>=3&&(!i||i>=3)?3:q>=2&&(!i||i>=2)?2:1:1,j=1/i}if(f.setAttribute("data-dpr",i),!g)if(g=e.createElement("meta"),g.setAttribute("name","viewport"),g.setAttribute("content","initial-scale="+j+", maximum-scale="+j+", minimum-scale="+j+", user-scalable=no"),f.firstElementChild)f.firstElementChild.appendChild(g);else{var r=e.createElement("div");r.appendChild(g),e.write(r.innerHTML)}a.addEventListener("resize",function(){clearTimeout(d),d=setTimeout(c,300)},!1),a.addEventListener("pageshow",function(a){a.persisted&&(clearTimeout(d),d=setTimeout(c,300))},!1),"complete"===e.readyState?e.body.style.fontSize=12*i+"px":e.addEventListener("DOMContentLoaded",function(){e.body.style.fontSize=12*i+"px"},!1),c(),k.dpr=a.dpr=i,k.refreshRem=c,k.rem2px=function(a){var b=parseFloat(a)*this.rem;return"string"==typeof a&&a.match(/rem$/)&&(b+="px"),b},k.px2rem=function(a){var b=parseFloat(a)/this.rem;return"string"==typeof a&&a.match(/px$/)&&(b+="rem"),b}}(window,window.lib||(window.lib={}));
	</script>
</head>
<body>
	<div id="mask" class='loading'>  <!-- class：none 关闭mask notFinish：信息输入未完整； offLine: 网络开小差 complaint: 收到投诉 support： 感谢支持 damn : 报修申请失败-->
		<div class="loading">
			<li class="o"></li>
			<li class="o"></li>
			<li class="o"></li>
			<li class="o"></li>
			<li class="o"></li>
			<li class="o"></li>
			<li class="o"></li>
			<li class="o"></li>
		</div>
		<div class="msg"> 
			<div class="close"></div>
			<p class="notFinish">你的数据还没有填写完整哟~</p>
			<p class="offLine">网络开小差了<br />稍后再来试试吧~</p>
			<p class="damn">报修失败，请稍后再试试吧~</p>
			<div class="btn">返回</div>
		</div>
		<div class="envelope">  
			<div class="top">
				<div class="close"></div>
			</div>
			<div class="bottom">
				<p class="complaint">你的投诉我们已经收到<br />我们将立即进行处理！</p>
				<p class="support">感谢你的支持我们会做得更好~</p>
				<div class="btn">返回</div>
			</div>
		</div>

		<div class="selection">
			<div class="option"></div>
		</div>
	</div>	
	<div id="main">
	<!-- <div id="mask"></div> -->
		<div class="topCon">
			<div class="content"> 
				<p class="userName"></p>
				<div class="btn" id="repairBtn"><a href="./repair.html">我要报修</a></div>
			</div>
		</div>
		<div class="sltCon clearfix">
			<div class=" l slt select">已完成</div>
			<div class="r slt">待解决</div>
		</div>
		<div id="content" class="">  <!-- class: noInfo  如果没有信息就增加这个class-->
			<div class="noContent">  
				<div class="icon"></div>
				<p>你还没有报修过噢</p>
			</div>
			<ul class="finished mainContent"><!-- 主页面下面已完成 和待解决  -->
				
			</ul>
			<ul class="waittosolve mainContent" style="display: none;">  <!-- 主页面下面已完成 和待解决  -->
				
			</ul>
		</div>
	</div>
	<div id="processing" class="process-finished none">  <!-- none -->
		<div class="hint">
			<i></i>
			<span>工作人员正在前往修理的路上……</span>
		</div>
		<div class="main">
			<ul>
				<li>
					<i class="icon icon1"></i>
					<p class="t">申报人</p>
					<p class="info userName">奔跑的萌新</p>
				</li>
				<li>
					<i class="icon icon2"></i>
					<p class="t">电话</p>
					<p class="info">学生公寓区 宁静苑4舍</p>
				</li>
				<li>
					<i class="icon icon3"></i>
					<p class="t">详细地址</p>
					<p class="info">学生公寓区 宁静苑4舍</p>
				</li>
				<li>
					<i class="icon icon4"></i>
					<p class="t">标题</p>
					<p class="info">学生公寓区 宁静苑4舍</p>
				</li>
				<div id="desc1" class="desc">
					我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，
				</div>
				<div class="spread"><span>展开</span><i class="arrowDown"></i></div>
			</ul>
			<div class="picCon">
				<img class="pic" src="./img/demo.jpg">
			<div class ="return">返回</div>
			</div>
		</div>
	</div>
	<div id="finished" class="process-finished none">  <!-- none -->   <!-- Finished START -->
		<div class="main">
			<ul>
				<li>
					<i class="icon icon1"></i>
					<p class="t">申报人</p>
					<p class="info">学生公寓区 宁静苑4舍</p>
				</li>
				<li>
					<i class="icon icon2"></i>
					<p class="t">电话</p>
					<p class="info">学生公寓区 宁静苑4舍</p>
				</li>
				<li>
					<i class="icon icon3"></i>
					<p class="t">详细地址</p>
					<p class="info">学生公寓区 宁静苑4舍</p>
				</li>
				<li>
					<i class="icon icon4"></i>
					<p class="t">标题</p>
					<p class="info">学生公寓区 宁静苑4舍</p>
				</li>
				<div id="desc2" class="desc">
					我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，我也不知道为什么就不转了，反正他就是不转了，
				</div>
				<div class="spread"><span>展开</span><i class="arrowDown"></i></div>
			</ul>
			<div class="picCon">
				<img class="pic" src="./img/demo.jpg">
			</div>
						
 		</div>
		<div class="response false">   <!-- false ： 评论已经提交过不能修改 -->
			<div class="t">
				<i class="icon"></i>
				<p>情况反馈</p>
				<div class="satisfy clearfix">
					<span>满意度:</span> 
					<div class="starBox clearfix">
						<div class="star fill"></div>
						<div class="star fill"></div>
						<div class="star fill"></div>
						<div class="star"></div>
						<div class="star n-margin-r"></div>
					</div>
				</div>
			</div>
			<form method="post" onsubmit="return false">
				<div class="textCon">
					<div class="bind"></div>
					<textarea maxlength="200" placeholder="请在这里输入详细反馈，二百字以内哦~"></textarea>
				</div>
				<div class="submitBtn">提交</div>
				<input type="number" name="starNum" style="display: none;">
				<input type="submit" name="" style="display: none;">
			</form>
		</div>
	</div>
</body>
</html>
<script type="text/javascript" src='./js/pack-0.5.js'></script>
<script type="text/javascript">
		var winH = getWinHeight(),
		winW = getWinWidth(),
		main = $$('#main'), 
		body = $$('body'),
		firstArea = $$('#main .topCon'),  //第一块区域
		secondArea = $$('#main .sltCon'),   //第二块区域*/
		extraArea = $$('#content'),
		MainContent = $$('.process-finished > .main'),
		stars = $$('.star'),
		hint = $$('.process-finished .hint'),
		hrefArr = window.location.href.split('/'),
		openId = hrefArr[hrefArr.length - 1].split('?')[1];
		var resetSize = function () {//初始化浏览器窗口大小
			winH = getWinHeight(),
			winW = getWinWidth();
				// rate = 720/485; //第一部分闭上第二部分的比例
			    /*适应宽屏幕手机*/
			main.style.width = winW + 'px';
			//主要部分main 高度
				MainContent[0].style.height = (winH - getIntStyle(hint,'height') - getIntStyle(hint,'marginBottom')) + 'px';
				// MainContent[1].style.height = winH + 'px';
			firstArea.style.height = winH/1205 * 468 + 'px';
			extraArea.style.height = (winH - getIntStyle(firstArea,'height') - secondArea.offsetHeight ) + 'px';
		}
		resetSize();
		window.onresize = resetSize;
	(function(){
 		var winH = window.innerHeight,
		    winW = window.innerWidth,
		    main = $$('#main'),
		    spreadBtn = $$('.spread'),  //收起展开 按钮
		    desc = $$('.desc'),   //描述内容
		    firstArea = $$('#main > .topCon'),
		    returnBtn = $$('.return'),  //返回按钮
		    secondArea = $$('#main > .sltCon'),
		    mainContents = $$('.mainContent'),
		    slts = $$('.sltCon .slt'),  // 已完成和 待解决 两个按钮
		    finishedList = $$('#content > ul.finished.mainContent li'),  //已完成下拉列表所有li
		    processingList = $$('#content > ul.waittosolve.mainContent li'), //待解决下拉列表所有li
		    repairPage = $$('#repair'),
		    repairSubmitBtn = $$('#repair .submitBtn'),  //报修页面 里面提交按钮
		    finishedPage = $$('#finished'),  //已經完成頁面 
		    finishedPageSubmitBtn = $$('#finished .submitBtn'),
		    processingPage = $$('#processing'),  //正在處理中頁面
		    processingPageSubmitBtn = $$('#processingPage .submit'),
		    allInput = $$('input'),
		    mask = $$('#mask'),  //全局遮罩层
		    closeMaskBtn = $$('#mask .close'),  //遮罩层里面 信息的关闭按钮
		    maskReturnBtn = $$('#mask .btn'), //所有弹框里面返回按钮
		    oUserName = $$('#main > div.topCon > div > p'),  //dom username 
		    repairBtn = $$('#repairBtn'),
		    userName = '',   //用户名 	(全局变量)
		    finishedContent = $$('#content > ul.finished.mainContent'),  //已完成ul
		    unfinishedContent = $$('#content > ul.waittosolve.mainContent'),  //待解决ul
		    response = $$('.response'),  //回馈兰
		    content = $$('#content'),
		    repairA = $$('#repairBtn > a'),
		    form = $$('#finished > div.response > form'),
		    commentUrl;
		    repairA.href = './repair.html?' + openId;
		main.style.height = winH + 'px';
		main.style.width = winW + 'px';
		content.style.height = winH - getIntStyle(firstArea,'height') - secondArea.offsetHeight + 'px';
		var allo = $$('#mask .loading .o');
			var loading = function (all,distance,time) {   //所有圆点 distance:  距离  time:周期
			var per_deg = 360/all.length;
			console.log(per_deg);
			l = all.length;
			for (var i = 0; i < l; i++) {
				all[i].index = i;
				all[i].style.cssText = 'transform: rotate('+ (all[i].index * per_deg) +'deg) translateX(50px) ;opacity: .5' ;
			}
			per_time = time / l;
			var start = 0;
			var timer = setInterval (function () {
				if (start >= l - 1) {
					start = 0;
				}else {
					start ++;
				}
				var currentDom = all[start],
					currentIndex = currentDom.index,
					preDom,
					prepreDom;
					if (currentIndex == 0) {
						preDom = all[l-1];
						prepreDom = all[l-2];
					}else if (currentIndex == 1) {
						preDom = all[0]
						prepreDom = all[l-1];
					} else {
						preDom = all[currentIndex-1];
						prepreDom = all[currentIndex-2];
					}

				currentDom.style.opacity = .9;
				preDom.style.opacity = .6;
				prepreDom.style.opacity = .3;
			},per_time)
		}
		loading(allo,50,2000)  

		ajax({
			// 'url' : 'http://172.33.16.137/Magicloop/index.php?s=/addon/BaoxiuAndTousu/Baoxiu/index/openid/' + openId + '',
			'url' : 'http://172.33.16.137/Magicloop/index.php?s=/addon/BaoxiuAndTousu/Baoxiu/index/openid/ouRCyjndQXTkjgtAuzUG4F3MZNa8',
			'method' : 'post',
			'success' : function (data) {
				var dataJson = JSON.parse(data),
					finishedJson = dataJson.data.finished,
					unfinishedJson = dataJson.data.unfinished,
					commentUrl = dataJson.data.remarkUrl;
					
				form.setAttribute('action',commentUrl);

				if (dataJson.status) {  
					userName = dataJson.data.stuInfo.realname;
					console.log(dataJson.data.stuInfo)
					oUserName.innerHTML = userName;
					mask.className = 'none';  //加载成功之后取消家在动画
					if (finishedJson.length != 0) {
						var l = finishedJson.length;
						console.log(l)
						for (var i = 0; i < l; i++) {
							loadData(finishedJson[i],finishedContent);
						}
					}
					console.log(unfinishedJson)
					if (unfinishedJson.length != 0) {
						var l = unfinishedJson.length;
						for (var i = 0; i < l; i++) {
							loadData(unfinishedJson[i],unfinishedContent);
						}
					}
				} else { /*加载失败*/
					alert('加载失败')
				};
			},
			'error' : function () {
				mask.className = 'offLine';
			}
		})

		function loadData (dataJson,targetDom) {  //刷新全局信息
				console.log(dataJson.wx_bxsj);
				try {
					var bxsj = dataJson.wx_bxsj.split(' ')[0].split('-'),  //报修时间（将年月日处理成数组的三个元素）
					year = bxsj[0],
					month = bxsj[1],
					day = bxsj[2];
				}catch(e) {

				}
			var bt = dataJson.wx_bt,  //标题
				picUrl = dataJson.wx_picUrl,  //图片地址
				wczt = dataJson.wx_wxztm,  //完成状态
				tel = dataJson.wx_bxdh, //报修电话
				//userName 用户名
				detailAddress = dataJson.wx_bxdd,  //详细地址
				desc = dataJson.wx_bxnr,  //描述详情
				comment = dataJson.wx_sfkhf;  //是否能够选择
				var oLi = document.createElement('li'),
					pt = document.createElement('p'),
					oDiv1 = document.createElement('div'),  //status
					oDiv2 = document.createElement('div'),  //t
					oDiv3 = document.createElement('div'),  //div3
					oI = document.createElement('i'),
					oP = document.createElement('p');
					oP.innerHTML = wczt;
					oDiv1.className = 'status';
					oDiv2.className = 't'
					pt.innerHTML = bt;
					oDiv3.className = 'time';
					oDiv3.innerHTML = ''+year+'年'+month+'月'+day+'日';
					console.log(bt);
					oLi.appendChild(pt);
					oDiv2.appendChild(oI);
					oDiv2.appendChild(oP);
					oDiv2.appendChild(oDiv3);
					oDiv1.appendChild(oDiv2);
					oLi.appendChild(oDiv1);
					oLi.setAttribute('detailAddress',detailAddress);
					oLi.setAttribute('tel',tel);
					oLi.setAttribute('title',bt);
					oLi.setAttribute('imgSrc',picUrl);
					oLi.setAttribute('comment',comment);
					oLi.setAttribute('desc',desc);
					if (targetDom === finishedContent) {
						oLi.addEventListener('click',function() {
							var infos = finishedPage.querySelectorAll('.main li p.info');
							infos[0].innerHTML = userName;
							infos[1].innerHTML = this.getAttribute('tel');
							infos[2].innerHTML = this.getAttribute('detailAddress');
							infos[3].innerHTML = this.getAttribute('title');	
							$$('#desc2').innerHTML = this.getAttribute('desc');
							$$('#finished > div.main > div > img').src = this.getAttribute('imgSrc');
							var isComment = this.getAttribute('comment');
							var btn = $$('#finished > div.response > form > div.submitBtn');
							if (isComment == '否') {  //不能够继续评价
								addClass(response,'false');
								btn.innerHTML = '返回';
								finishedPageSubmitBtn.onclick = function () {
									addClass(finishedPage,'none');
								}
							}else {
								removeClass(response,'false');
								btn.innerHTML = '提交';
								finishedPageSubmitBtn.onclick = function () {
									;
								}
							}
							removeClass(finishedPage,'none');
							console.log($$('#desc2'));
							var imgSrc = this.getAttribute('imgSrc');
							if (imgSrc == 'undefined') {
								$$('#finished > div.main > div').innerHTML = '';
							} else {
								$$('#finished > div.main > div').innerHTML = '<img class = "pic" src= '+ imgSrc +'  />';
							}
						})
					} else {
						oLi.addEventListener('click',function () {
							removeClass(processingPage,'none');
							var infos = processingPage.querySelectorAll('.info');
							infos[0].innerHTML = userName;
							infos[1].innerHTML = this.getAttribute('tel');
							infos[2].innerHTML = this.getAttribute('detailAddress');
							infos[3].innerHTML = this.getAttribute('title');
							$$('#desc1').innerHTML = this.getAttribute('desc');
							var imgSrc = this.getAttribute('imgSrc'),
								img = $$('#processing > div.main > div > img');
							if (imgSrc == 'undefined') {
								img.style.display = 'none';
							} else {
								img.style.display = 'block';
								img.src = imgSrc;
							}
						});

					}
					targetDom.appendChild(oLi);
		}



		on(slts,'click',function(){   /*点击选项卡事件*/
			removeClass(slts,'select');
			addClass(this,'select');
			for (var i = 0; i < mainContents.length; i++) {
				mainContents[i].style.display = 'none';
	 			mainContents[this.index].style.display = 'block';
	 		}
		})
		on (spreadBtn,'click', function () {  /*收起展开按钮按下事件*/	
			toggleClass(desc,'slideDown');
		})
		on (returnBtn,'click', function () {
			addClass(processingPage,'none');
		})
		on (repairBtn, 'click', function(){  //我要报修按钮点击后  打开我要报修页面 

		})
		on (repairSubmitBtn, 'click', function () {
			repairPage.style.display = 'none';
		})
		
		// on(finishedList,'click',function(){  //所有已完成列表点击之后弹出已完成表单
		// 	removeClass(finishedPage,'none');
		// })
		
		// on(processingList,'click',function(){
		// 	removeClass(processingPage,'none');
		// })
		on(processingPageSubmitBtn,'click',function (){
			addClass(processingPage,'none');
		})
		on(closeMaskBtn,'click',function(){  //信息弹框里面关闭按钮
			addClass(mask,'none');
		})
		on(maskReturnBtn,'click',function (){

		})
		var Status = {
			offLine: function () {  //网络不稳定
				mask.className = '';
				addClass(mask,'offLine');
			},
			complaint: function () { //收到投訴
				mask.className = '';
				addClass(mask,'complaint');
			},
			supprt: function () {  //感謝支持
				mask.className = '';
				addClass(mask,'support');
			},
			notFinish: function () {  //信息為填寫完成
				mask.className = '';
				addClass(mask,'notFinish');
			}				
		}
		// Status.offLine();
		// Status.complaint();
		for (var i = 0; i < stars.length; i++) {
			stars[i].index = i;
		}
		on(stars,'click',function () {  //小星星点击触发事件
			if (!hasClass(response,'false')) {
				giveStar(this.index);
			}
		})
		function giveStar (index) {
			var l = stars.length;
			for (var i = 0; i < l; i++) {
				removeClass(stars[i],'fill');
			}
			for (var j = 0; j <= index; j++) {
				addClass(stars[j],'fill');
			}
		}
	})()


</script>
